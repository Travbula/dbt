version: 2

models:
  - name: fct_horse_in_race
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - race_id
            - horse_id
    
    meta:
      joins:
        - join: dim_breeder
          sql_on: ${dim_breeder.breeder_name} = ${fct_horse_in_race.breeder_name}
        - join: dim_driver
          sql_on: ${dim_driver.driver_id} = ${fct_horse_in_race.driver_id}
        - join: dim_horse
          sql_on: ${dim_horse.horse_id} = ${fct_horse_in_race.horse_id}
        - join: dim_owner
          sql_on: ${dim_owner.owner_name} = ${fct_horse_in_race.owner_name}
        - join: dim_race
          sql_on: ${dim_race.race_id} = ${fct_horse_in_race.race_id}
        - join: dim_racetrack
          sql_on: ${dim_racetrack.racetrack_id} = ${fct_horse_in_race.racetrack_id}

    columns:
      - name: race_id
        meta:
          metrics:
            race_count:
              type: count_distinct
        description: ID of race
      - name: horse_id
        description: ID of horse
      - name: driver_id
        description: ID of horse driver
      - name: racetrack_id
        description: ID of racetrack where the horse raced
      - name: owner_name
        description: Name of horse owner
      - name: breeder_name
        description: Name of breeder of the horse
      - name: start_number
        description: Start number horse had in race
      - name: extra_distance
        description: How much extra distance (for volt)
      - name: shoes
        description: Type of horse shoes
      - name: sulky
        description: Type of sulky
      - name: finishing_position
        description: The position the horse finished in
        meta:
          metrics:
            avg_finishing_position:
              type: average
      - name: prize
        description: How much money won in race
        meta:
          metrics:
            avg_prize:
              type: average
      - name: kmtime
        description: Time pr km
      - name: trainer_name
        description: The person who trains the horse at the time of the race
      - name: first_place
        description: 1 if the horse won the race
        meta:
          metrics:
            avg_first_place:
              type: average
      - name: second_place
        description: 1 if the horse finished second in the race
      - name: third_place
        description: 1 if the horse finished third in the race
      - name: win_odds
        description: The final rikstoto win betting odds for the horse in the race
      - name: horses_beaten
        description: Number of horses beaten in the race
        meta:
          metrics:
            avg_horses_beaten:
              type: average
      - name: result_score
        description: A scoring based on finishing position and number of horses in the race
        meta:
          metrics:
            avg_result_score:
              type: average
      - name: galloped
        description: Did th ehorse gallop during the race?
        meta:
          metrics:
            gallop_percentage:
              type: average
      - name: paced
        description: Did the horse pace during the race?
      - name: broke_race
        description: Did the horse break the race?
      - name: timed
        description: Was the horse timed?
      - name: distanced
        description: Was the horse distanced?
      - name: disqualified
        description: Was the horse disqualified?