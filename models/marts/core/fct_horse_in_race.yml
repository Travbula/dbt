version: 2

models:
  - name: fct_horse_in_race
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - race_id
            - horse_id
    
    meta:
      joins:
        - join: dim_breeder
          sql_on: ${dim_breeder.breeder_name} = ${fct_horse_in_race.breeder_name}
        - join: dim_driver
          sql_on: ${dim_driver.driver_id} = ${fct_horse_in_race.driver_id}
        - join: dim_horse
          sql_on: ${dim_horse.horse_id} = ${fct_horse_in_race.horse_id}
        - join: dim_owner
          sql_on: ${dim_owner.owner_name} = ${fct_horse_in_race.owner_name}
        - join: dim_race
          sql_on: ${dim_race.race_id} = ${fct_horse_in_race.race_id}
        - join: dim_racetrack
          sql_on: ${dim_racetrack.racetrack_id} = ${fct_horse_in_race.racetrack_id}

    columns:
      - name: race_id
        meta:
          metrics:
            race_count:
              type: count_distinct
        description: ID of race
      - name: horse_id
        description: ID of horse
      - name: driver_id
        description: ID of horse driver
      - name: racetrack_id
        description: ID of racetrack where the horse raced
      - name: owner_name
        description: Name of horse owner
      - name: breeder_name
        description: Name of breeder of the horse
      - name: start_number
        description: Start number horse had in race
      - name: post_position
        description: Where the horse started the race (taking into accounts its start number and scratches in the race)
      - name: extra_distance
        description: How much extra distance (for volt)
      - name: shoes
        description: Type of horse shoes
      - name: sulky
        description: Type of sulky
      - name: finishing_position
        description: The position the horse finished in
        meta:
          metrics:
            avg_finishing_position:
              type: average
      - name: prize
        description: How much money won in race
        meta:
          metrics:
            avg_prize:
              type: average
      - name: kmtime
        description: Time pr km
      - name: trainer_name
        description: The person who trains the horse at the time of the race
      - name: bet_winnings
        description: How much won by betting on the horse to win (and how much lost when the horse did not win)
        meta:
          metrics:
            avg_bet_winnings:
              type: average
            sum_bet_winnings:
              type: sum

      - name: second_place
        description: 1 if the horse finished second in the race
      - name: third_place
        description: 1 if the horse finished third in the race
      - name: win_odds
        description: The final rikstoto win betting odds for the horse in the race
      - name: horses_beaten
        description: Number of horses beaten in the race
        meta:
          metrics:
            avg_horses_beaten:
              type: average
      - name: result_score
        description: A scoring based on finishing position and number of horses in the race
        meta:
          metrics:
            avg_result_score:
              type: average
      - name: galloped
        description: Did th ehorse gallop during the race?
        meta:
          metrics:
            gallop_percentage:
              type: average
      - name: paced
        description: Did the horse pace during the race?
      - name: broke_race
        description: Did the horse break the race?
      - name: timed
        description: Was the horse timed?
      - name: distanced
        description: Was the horse distanced?
      - name: disqualified
        description: Was the horse disqualified?
      - name: winnings
        description: How much won by betting on the horse to win
        meta:
          metrics:
            avg_winnings:
              type: average
      - name: winner_odds
        description: Odds of the horse if it won, null otherwise
        meta:
          metrics:
            avg_winner_odds:
              type: average
      - name: first_place
        description: 1 if the horse won the race
        meta:
          metrics:
            avg_first_place:
              type: average
      - name: winning_distance
        description: The distance the horse won with
      - name: last_500m_time
        description: The time of the last 500m of the race (when the horse won?)
        meta:
          metrics:
            fastest_sprint:
              type: min
      - name: lead_after_500m
        description: 1 if horse lead after 500m, 0 if horse did not lead and null if it is unknown who leaded
      - name: lead_after_500m_time
        description: Time for first 500m when horse also lead after 500m
        meta:
          metrics:
            fastest_first_500m:
              type: min
            average_first_500m:
              type: average
            slowest_first_500m:
              type: max
      - name: lead_after_1000m
        description: 1 if horse lead after 1000m, 0 if horse did not lead and null if it is unknown who leaded
      - name: lead_after_1000m_time
        description: Time for first 500m when horse also lead after 1000m
        meta:
          metrics:
            fastest_first_1000m:
              type: min
            average_first_1000m:
              type: average
            slowest_first_1000m:
              type: max
      - name: lead_from_500m_and_win
        description: 1 if horse lead after 500m and win
      - name: lead_from_1000m_and_win
        description: 1 if horse lead after 1000m and win